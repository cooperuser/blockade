<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Blockade - Editor</title>
		<link rel="stylesheet" href="css/bootstrap.css" title="dark">
		<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
		<style>
			td {
				width: 50px;
				height: 50px;
				text-align: center;
				padding: 1px;
			}
			div.tile {
				background-color: #333333;
				height: 48px;
			}
			div.fake-tile {
				background-color: #333333;
				width: 48px;
				height: 48px;
			}
			.container {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translateX(-50%) translateY(-50%);
			}
			.block {
				margin: 2px;
				width: 46px;
				height: 46px;
				pointer-events: none;
			}
			.block-group {
				pointer-events: none;
			}
			.plate {
				margin: 17px;
				padding: 5px;
				width: 16px;
				height: 16px;
			}
			#selector {
				padding: 0px;
				border: 0px;
			}
		</style>
	</head>
	<body style="font-family: Hasklig;">
		<nav id="menu" class="navbar navbar-default" style="width: 410px;position: absolute; left:-353px;">
			<div class="container-fluid" style="padding-right: 0px;">
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li><a href="#" class="modal-button" data-toggle="modal" data-target="#openModal" id="openButton">Open</a></li>
						<li><a href="#" class="modal-button" data-toggle="modal" data-target="#saveModal">Save</a></li>
						<li><a href="#" id="play">Play</a></li>
						<li><a href="#" class="modal-button" data-toggle="modal" data-target="#helpModal">Help</a></li>
						<li><a href="menu.html">Exit</a></li>
						<li><a id="arrow" style="padding-right: 0px;">»</a></li>
					</ul>
				</div>
			</div>
		</nav>
		<div class="container" id="game" align="center" style="display: inline-block; margin: 0px; padding: 0px;">
			<table id="table" style="margin: 0px;" class="">
				<tbody></tbody>
			</table>
		</div>
		<nav id="panel" class="navbar navbar-default" style="position: absolute; bottom: 0px; left: 0px; right: 0px; margin-bottom: 0px; background-color: #3d4650;">
			<div class="container-fluid">
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
					<ul class="nav navbar-nav" id="selectors">
						<li style="margin: 3px;"><a href="#" class="btn btn-primary select select-blank selected" data-id="blank" style="padding: 1px;"><div class="fake-tile" style="background-color: #222222"></div></a></li>
						<li style="margin: 3px;"><a href="#" class="btn btn-primary select select-tile" data-id="tile" style="padding: 1px;"><div class="fake-tile"></div></a></li>
						<li style="margin: 3px;"><button href="#" class="btn btn-primary select select-block" data-id="block" style="padding: 1px;"><a class="btn btn-info disabled block"></a></button></li>
						<li style="margin: 3px;"><button href="#" class="btn btn-primary select select-plate" data-id="plate" style="padding: 1px;"><a href="#" class="btn btn-warning disabled plate"></a></button></li>
					</ul>
					<a class="btn btn-warning" id="selector" style="position: absolute; width: 60px; height: 4px; left: 30px; bottom: 2px;"></a>
				</div>
			</div>
		</nav>
		<div id="openModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Open Level</h4>
					</div>
					<div class="modal-body">
						<p><select id="selectBox" multiple class="form-control" style="background-color: #464646; color: #ffffff; height: 200px;">
						</select></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary" id="open">Open</button>
					</div>
				</div>
			</div>
		</div>
		<div id="saveModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Save Level</h4>
					</div>
					<div class="modal-body">
						<p><input type="text" class="form-control" placeholder="Name" id="name"></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary" id="save">Save</button>
					</div>
				</div>
			</div>
		</div>
		<div id="helpModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Help</h4>
					</div>
					<div class="modal-body">
						<p>TODO</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script>
		const fs = require("fs");
		var width = 15;
		var height = 9;
		var grid = []
		var leveldata = {
			grid: [width, height],
			tiles: [

			],
			blocks: [

			],
			plates: [

			],
			data: {

			}
		}
		var baseleveldata = {
			grid: [width, height],
			tiles: [

			],
			blocks: [

			],
			plates: [

			],
			data: {

			}
		}

		var select = "blank";

		var place = {
			"tile": function(pos) {
				$(`.cell.x-${pos.x}.y-${pos.y}`).append(`<div class="tile ob-x-${pos.x} ob-y-${pos.y}"></div>`);
			},
			"block": function(pos) {
				$("#game").append(`<span class="block-group ob-x-${pos.x} ob-y-${pos.y}" style="left: ${pos.x * 50}px; top: ${(pos.y * 50)+"px"}; position: absolute;" data-id='{"x": ${pos.x}, "y": ${pos.y}}'><a href="#" class="btn btn-info disabled block" data-id='{"x": ${pos.x}, "y": ${pos.y}}'></a></span>`)
			},
			"plate": function(pos) {
				$("#game").append(`<a href="#" class="btn btn-warning disabled plate ob-x-${pos.x} ob-y-${pos.y}" style="left: ${pos.x * 50}px; top: ${(pos.y * 50)+"px"}; position: absolute;"></a>`);
			}
		}

		for (var x = 0; x < width; x++) {
			grid.push([]);
			for (var y = 0; y < height; y++) {
				grid[x].push([]);
			}
		}

		function remove(pos) {
			$(`.ob-x-${pos.x}.ob-y-${pos.y}`).remove();
		}

		function setGrid() {
			leveldata = {
				grid: [width, height],
				tiles: [

				],
				blocks: [

				],
				plates: [

				],
				data: {

				}
			};
			for (var x = 0; x < grid.length; x++) {
				for (var y = 0; y < grid[x].length; y++) {
					for (var z = 0; z < grid[x][y].length; z++) {
						item = grid[x][y][z];
						if (item == "tile") {
							leveldata.tiles.push([x, y]);
						}
						if (item == "block") {
							leveldata.blocks.push([x, y]);
						}
						if (item == "plate") {
							leveldata.plates.push([x, y]);
						}
					}
				}
			}
		}

		for (var j = 0; j < height; j++) {
			$("#table>tbody").append(`<tr id="row-${j}"></tr>`);
			for (var i = 0; i < width; i++) {
				$(`#row-${j}`).append(`<td class="cell x-${i} y-${j}" data-id='{"x": ${i}, "y": ${j}}'></td>`);
			}
		}

		var _GET = {}
		for (var g = 0; g < location.search.slice(1).split('&').length; g++) {
			_GET[location.search.slice(1).split('&')[g].split("=")[0]] = location.search.slice(1).split('&')[g].split("=")[1]
		}

		if (location.search.split("?")[1].split("&")[0].split('=')[1] == '1') {
			leveldata = JSON.parse(fs.readFileSync(`${__dirname}/data/levels/temp.json`, "utf8").replace(/(?:\r\n|\r|\n)/g, "").replace("  ", ""));
			leveldata.tiles.forEach(function(item, index) {
				grid[item[0]][item[1]].push("tile");
				place["tile"]({x: item[0], y: [item[1]]});
			});
			leveldata.plates.forEach(function(item, index) {
				grid[item[0]][item[1]].push("plate");
				place["plate"]({x: item[0], y: [item[1]]});
			});
			leveldata.blocks.forEach(function(item, index) {
				grid[item[0]][item[1]].push("block");
				place["block"]({x: item[0], y: [item[1]]});
			});
		} else if (_GET["play"] == '2') {
			name = _GET["name"]
			leveldata = JSON.parse(fs.readFileSync(`${__dirname}/data/levels/user/${name}`, "utf8").replace(/(?:\r\n|\r|\n)/g, "").replace("  ", ""));
			leveldata.tiles.forEach(function(item, index) {
				grid[item[0]][item[1]].push("tile");
				place["tile"]({x: item[0], y: [item[1]]});
			});
			leveldata.plates.forEach(function(item, index) {
				grid[item[0]][item[1]].push("plate");
				place["plate"]({x: item[0], y: [item[1]]});
			});
			leveldata.blocks.forEach(function(item, index) {
				grid[item[0]][item[1]].push("block");
				place["block"]({x: item[0], y: [item[1]]});
			});
		}

		$("#table").on("click", ".cell", function() {
			var pos = $(this).data("id");
			if (select != "blank") {
				if (!grid[pos.x][pos.y].includes(select)) {
					if (select != "tile" && !grid[pos.x][pos.y].includes("tile")) {
						grid[pos.x][pos.y].push("tile");
						place["tile"](pos);
					}
					grid[pos.x][pos.y].push(select);
					place[select](pos);
				}
			} else {
				grid[pos.x][pos.y] = []
				remove(pos);
			}
		});

		$("#table").on("contextmenu", ".cell", function() {
			var pos = $(this).data("id");
			type = grid[pos.x][pos.y].pop();
			if (type != undefined) {
				type += (type == "block")?"-group":"";
				$(`.${type}.ob-x-${pos.x}.ob-y-${pos.y}`).remove();
			}
		});

		$(".select").on("click", function() {
			$(`.select-${select}`).removeClass("selected");
			select = $(this).data("id");
			$(`.select-${select}`).addClass("selected");
			$("#selector").animate({left: $(this).parent().position().left, width: $(this).parent().width() + 6}, 200);
		})

		$("#menu").on("mouseenter", function() {
			setTimeout(function() {$("#arrow").html("«")}, 100)
			$(this).animate({left:0}, 200);
		});

		$("#menu").on("mouseleave", function() {
			setTimeout(function() {$("#arrow").html("»")}, 100)
			$(this).animate({left:-353}, 200);
		});

		$("#openButton").on("click", function() {
			files = fs.readdirSync(`${__dirname}/data/levels/user`);
			$("#selectBox").empty();
			for (var i = 0; i < files.length; i++) {
				$("#selectBox").append(`<option>${files[i]}</option>`)
			}
		});

		$("#open").on("click", function() {
			if ($("select").val().length > 0) {
				name = $("select").val();
				location = location.pathname + "?play=2&name="+name;
			}
		});

		$("#play").on("click", function() {
			setGrid();
			fs.writeFileSync(`${__dirname}/data/levels/temp.json`, JSON.stringify(leveldata), "utf8");
			location = "play.html?leveldata=temp&custom=2";
		})

		$("#save").on("click", function() {
			setGrid();
			if ($("#name").val() != "") {
				name = $("#name").val();
				fs.writeFileSync(`${__dirname}/data/levels/user/${name}.json`, JSON.stringify(leveldata), "utf8");
			}
			$("#saveModal").modal("toggle");
		});

		$(document).on("keydown", function(event) {
			if (event.key == "1") {
				$(`.select-${"blank"}`).trigger("click");
			} else if (event.key == "2") {
				$(`.select-${"tile"}`).trigger("click");
			} else if (event.key == "3") {
				$(`.select-${"block"}`).trigger("click");
			} else if (event.key == "4") {
				$(`.select-${"plate"}`).trigger("click");
			} else if (event.key == "p") {
				$("#play").trigger("click");
			}
		});
	</script>
</html>